<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>新学说支付中心</title>
<link rel="shortcut icon" href="https://nsi-official.oss-cn-zhangjiakou.aliyuncs.com/dist/static/favicon.ico" type="favicon">
<link id="payCss" rel="stylesheet" href="static/css/pay.css">
<script src="http://at.alicdn.com/t/font_759425_24cd0dfa2r1.js"></script>
<script src="http://at.alicdn.com/t/font_759425_gqr9ch4aw8l.js"></script>
</head>
<body>
	<div class="pc_show">
		<div><img style="max-height:730px;" src="static/img/center.jpg" alt=""></div>
		<div class="cart-body">
			<div class="cart-body-title">
				<div class="clearfix">
					<h2 class="trade-title">
						订单信息
					</h2>
				</div>
				<ul class="js-itemUl item-ul" style="height: 150px;">
					<li class="item clearfix">
						<div class="item-left left clearfix">					
							<dl class="left">
								<a href="javascript:" target="_blank">
									<dt class="payinfo">国际学校市场的现状和态势</dt> 
								</a>
							</dl>
						</div>
						<div class="item-right right">
							<div class="price clearfix">
								<span class="price-text">实付金额：</span>
								<em style="font-size:20px;">￥</em>
								<span class="payfee1">366.00</span>
							</div>
						</div>
					</li>
				</ul>	
			</div>
			<div class="pay-method">
				<h2 class="pay-method-title">支付方式</h2>
				<ul class="clearfix js-pay-method">
					<li class="pay-way alipay active" data-type="1" data-account="2">
						<div class="bottomright">
							<div class="triangle"><svg class="icon imv2-check" aria-hidden="true">
							    <use xlink:href="#icon-duihao2"></use>
							</svg></div>
						</div>
					</li>
					<li class="pay-way wxpay" data-type="2">
						<div class="bottomright">
							<div class="triangle"><svg class="icon imv2-check" aria-hidden="true">
							    <use xlink:href="#icon-duihao2"></use>
							</svg></div>
							
						</div>
					</li>
				</ul>
			</div>
			<div class="pay-summary clearfix huabei-active">
				<div class="summary">
					<div class="clearfix total">
						<span class="label">应付金额：</span>
						<span class="price">
							<em>￥</em>
							<span class="payfee1">366.00</span>
						</span>
					</div>
					<div class="submit-warp clearfix">
						<span class="pay-summary-submit js-pay-submit">立即支付</span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="mob_show">
		<h1>新学说支付中心</h1>
		<div class="cart-body">
			<div class="cart-body-title">
				
					<h2 class="trade-title">
						商品信息
					</h2>
				<ul class="js-itemUl item-ul">
					<li class="item clearfix" data-cid="$info.type_id">
						<div class="item-left clearfix">					
							<dl class="left">
								<a href="javascript:" target="_blank">
									<dt class="payinfo">国际学校市场的现状和态势国际学校市场的现状和态势国际学校市场的现状和态势国际学校市场的现状和态势国际学校市场的现状和态势</dt>
								</a>
							</dl>
						</div>
						<div class="item-right">
							<div class="price clearfix">
								<span class="price-text">实付金额：</span>
								<em style="font-style:normal;font-size:20px;">￥</em>
								<span class="payfee1">366.00</span>
							</div>
						</div>
					</li>
				</ul>
			</div>
			<div class="pay-method">
				<h2 class="pay-method-title">支付方式</h2>
				<ul class="js-pay-method">
					<li data-type="2">
						
						<div class="pay-way wxpay"><svg style="font-size:35px;margin:0 10px 0 20px;color:#333;" class="icon" aria-hidden="true">
							    <use xlink:href="#icon-wechat"></use>
							</svg><span style="font-size:26px;margin:0px 10px 0  0px;">微信支付</span></div>
						<div class="greenIcon active">
						</div>
						<!-- <div class="selectDiv"><svg class="icon mobYes" aria-hidden="true">
							    <use xlink:href="#icon-duihao2"></use>
							</svg></div> -->
					</li>
					<li>
						
						<div class="pay-way alipay"><svg class="icon" style="font-size:35px;margin:0 10px 0 20px;" aria-hidden="true">
							    <use xlink:href="#icon-zhifubao"></use>
							</svg><span style="font-size:26px;margin:0px 10px 0 0px;color:#333;">支付宝</span></div>
						<div class="greenIcon alipayActivess">
						</div>
						<!-- <div class="selectDiv alipayActive active"><svg class="icon mobYes" aria-hidden="true">
							    <use xlink:href="#icon-duihao2"></use>
							</svg></div> -->
					</li>
					
				</ul>
			</div>
		</div>
		<div class="pay-summary">
			<ul>
				<li><span>实付 </span> <span class="payfee">￥3999</span></li>
				<li class="payNow">立即支付</li>
			</ul>
		</div>
	</div>
<script src="static/js/jquery-3.2.1.min.js"></script>
<script src="lib/layer/layer.js"></script>
<script src="static/js/config.js"></script>
<script src="static/js/pay.js"></script>
<script>
	var pay=new Pay()
	pay.init()

	//微信内嵌支付
	if (pay.URLdata.code) {
		$('body').hide()
		$.ajax({
	        type: 'post',
	        data: {
	            code: pay.URLdata.code
	        },
	        url: baseUrl + '/wxPay/getInfo.do',
	        success: function(msg) {
	        	
	            var openid = msg.data.openid
	            // sub.click(function() {
	                $.ajax({
	                    type: 'get',
	                    url: baseUrl + '/wxPay/pay.do',
	                    data: {
	                        "attach": localStorage["paymail"]+'$'+localStorage["payfee"]+'$'+localStorage["payinfo"]+'$'+localStorage["groom"]+'$'+localStorage["random"],
	                        "openid": openid,
	                        "body":localStorage["paymail"] ,
	                        "total_fee": localStorage["payfee"]
	                    },
	                    success: function(msg) {
	                        var appId = msg.data.appId,
	                            timeStamp = msg.data.timeStamp,
	                            nonceStr = msg.data.nonceStr,
	                            package = msg.data.package,
	                            signType = msg.data.signType,
	                            paySign = msg.data.paySign

	                        function onBridgeReady() {
	                            WeixinJSBridge.invoke(
	                                'getBrandWCPayRequest', {
	                                    "appId": appId, //公众号名称，由商户传入     
	                                    "timeStamp": timeStamp, //时间戳，自1970年以来的秒数     
	                                    "nonceStr": nonceStr, //随机串     
	                                    "package": package,
	                                    "signType": signType, //微信签名方式：     
	                                    "paySign": paySign //微信签名 
	                                },
	                                function(res) {
	                                    if (res.err_msg == "get_brand_wcpay_request:ok") {
	                                    	window.location.href=localStorage["CallbackUrl"]
	                                       // alert("支付成功")
	                                        //location.href = "../metM.html"
	                                    } // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。 
	                                }
	                            );
	                        }
	                        if (typeof WeixinJSBridge == "undefined") {
	                            if (document.addEventListener) {
	                                document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
	                            } else if (document.attachEvent) {
	                                document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
	                                document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
	                            }
	                        } else {
	                            onBridgeReady();
	                        }
	                    },
	                    error: function() {
	                        console.log("error in pay.do")
	                    }
	                })
	           // })
	        },
	        error: function() {
	            console.log("error")
	        }
	    })
	}else{
		pay.URLdata.paymail=pay.URLdata.paymail.replace('*','@')
		localStorage["paymail"]=pay.URLdata.paymail
		localStorage["payfee"]=pay.URLdata.payfee
		localStorage["random"]=pay.URLdata.random
		$('.payfee').html('￥'+pay.URLdata.payfee)
		$('.payfee1').html(pay.URLdata.payfee)
		pay.URLdata.groom=pay.URLdata.groom.replace('*','@')
		localStorage["groom"]=pay.URLdata.groom
		pay.URLdata.payinfo=decodeURI(pay.URLdata.payinfo)
		localStorage["payinfo"]=pay.URLdata.payinfo
		$('.payinfo').html(pay.URLdata.payinfo)
		localStorage["random"]=pay.URLdata.random
		localStorage["CallbackUrl"]=pay.URLdata.CallbackUrl
	}
	//移动端
	if(pay.IsMobile){
		$('.mob_show').show()
		$('.pc_show').hide()
		$('#payCss').attr('href','static/css/paymob.css')
		$('head').append('<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no">')
		$('.greenIcon').click(function(){
			$('.greenIcon').removeClass('active')
			$(this).addClass('active')
		})
		$('.payNow').click(function(){
			if($('.alipayActivess').hasClass('active')){
				if (pay.isWeixn) {
					layer.alert('微信浏览器不支持支付宝支付,请点击右上角在系统浏览器中打开',{icon:6,skin: 'layui-layer-molv',title:'提示' ,closeBtn: 0},function () {
                          layer.closeAll()
                    })
				}else{
					pay.aliPayAjax(baseUrl+'/aliPay/ali_app_pay.do','mob')
				}
				
			}else{
				if(pay.isWeixn){
					window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx37e5ddff7dc5282e&redirect_uri=http%3A%2F%2Fdata.xinxueshuo.cn%2Fpay%2Fpay.html&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect"
				}else{
					pay.weiXinH5Ajax()
				}
			}
		})
	}else{
		//pc端
		$('.mob_show').hide()
		$('.pc_show').show()
		$('.triangle').eq(0).show()
		$('#payCss').attr('href','static/css/pay.css')
		$('.js-pay-method li').click(function(event) {
			$('.js-pay-method li').removeClass('active')
			$(this).addClass('active')
			$('.triangle').hide()
			$('.triangle').eq($(this).index()).show()
		});

		$('.pay-summary-submit').click(function(){
			if($('.alipay').hasClass('active')){
				pay.aliPayAjax(baseUrl+'/aliPay/ali_pc_pay.do','pc')
			}else{
				pay.weiXinPCAjax(function(msg){
					layer.open({
					  type: 1,
					  title: false,
					  closeBtn: 0,
					  shadeClose: true,
					  content: '<div style="margin-top:-20px;width:300px;height:340px;text-align:center;"><h1 class="price" style="font-size: 16px;color: #545c63;line-height: 24px;margin-top:45px;font-weight: 700;">微信支付￥<span class="payfee1">'+pay.URLdata.payfee+'</span></h1><img style="width:220px;height:220px;text-align:center" src="'+msg.data+'" alt=""><p style="font-size: 12px;color: #545c63;line-height: 18px;"><img style="width:195px;height:65px;" src="./static/img/show.png" alt="" /></p></div>'
					});
					pay.paySearch(baseUrl+'/wxPay/query_wxpay_status.do','attach')
				})
			}
		})
	}
</script>
</body>
</html>